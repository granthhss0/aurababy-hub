<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Movement Hub</title>

<!-- socket.io -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
/* ====== UNCHANGED STYLES (100%) ====== */
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto}
.screen{width:100vw;height:100vh;background:linear-gradient(135deg,#1e3a8a,#581c87,#312e81);position:relative}
.grid-bg{position:absolute;inset:0;opacity:.2;background-image:linear-gradient(rgba(255,255,255,.1)1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.1)1px,transparent 1px);background-size:50px 50px}
.player{position:absolute;width:48px;height:48px;border-radius:8px;box-shadow:0 0 20px rgba(34,211,238,.6);transition:all 75ms;overflow:hidden}
.username-label{position:absolute;background:rgba(0,0,0,.7);color:#22d3ee;padding:4px 12px;border-radius:6px;font-weight:700;transform:translateX(-50%)}
.username-label.admin{background:linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet);color:white}
.hud{position:absolute;top:16px;left:16px;background:rgba(0,0,0,.5);padding:12px;border-radius:8px;color:white}
.babies-button,.admin-button{width:100%;margin-bottom:6px;padding:8px;border-radius:6px;border:none;font-weight:700;color:white;cursor:pointer}
.babies-button{background:linear-gradient(90deg,#22d3ee,#3b82f6)}
.admin-button{background:linear-gradient(90deg,#f97316,#ef4444)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:999}
.modal{background:rgba(0,0,0,.9);border-radius:16px;padding:24px;color:white;width:92%;max-width:900px}
.character-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.character-option{border:2px solid rgba(255,255,255,.15);padding:12px;border-radius:12px;cursor:pointer;text-align:center}
.character-option.selected{border-color:#22d3ee}
.center-container{display:flex;align-items:center;justify-content:center;height:100vh}
.welcome-box{background:rgba(0,0,0,.5);padding:32px;border-radius:16px;width:90%;max-width:420px;color:white}
.input{width:100%;padding:12px;border-radius:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:white;margin-bottom:12px}
.button{width:100%;padding:12px;border-radius:8px;background:linear-gradient(90deg,#22d3ee,#3b82f6);border:none;color:white;font-weight:800;cursor:pointer}
.error{background:rgba(239,68,68,.2);padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>
<div id="root"></div>

<script type="module">
import React from "https://cdn.skypack.dev/react@18.2.0";
import ReactDOM from "https://cdn.skypack.dev/react-dom@18.2.0";

const socket = io("https://aurababy-hub0.onrender.com", {
  transports: ["websocket"]
});

const { useState, useEffect, useRef } = React;

function MovementHub() {
  const [username,setUsername]=useState(null);
  const [input,setInput]=useState("");
  const [error,setError]=useState("");
  const [players,setPlayers]=useState({});
  const [pos,setPos]=useState({x:200,y:200});
  const [character,setCharacter]=useState("aurababy");
  const [showModal,setShowModal]=useState(false);

  const idRef=useRef(crypto.randomUUID());
  const keys=useRef({});
  const SPEED=4;

  const characters={
    aurababy:{img:"https://i.ibb.co/nq467xv6/aurababy.png"},
    goonerbaby:{img:"https://i.ibb.co/ZRPGHj01/goonerbaby.png"},
    fattiebaby:{img:"https://i.ibb.co/Kj0gKt2Q/fattiebaby.png"}
  };

  /* ===== SOCKET EVENTS ===== */
  useEffect(()=>{
    socket.on("state",state=>setPlayers(state));
    socket.on("disconnect",()=>setPlayers({}));
    return ()=>socket.off();
  },[]);

  /* ===== JOIN ===== */
  useEffect(()=>{
    if(!username)return;
    socket.emit("join",{
      id:idRef.current,
      username,
      character,
      x:pos.x,
      y:pos.y
    });
  },[username]);

  /* ===== MOVEMENT ===== */
  useEffect(()=>{
    const down=e=>keys.current[e.key]=true;
    const up=e=>keys.current[e.key]=false;

    const loop=()=>{
      let dx=0,dy=0;
      if(keys.current.w||keys.current.ArrowUp)dy-=1;
      if(keys.current.s||keys.current.ArrowDown)dy+=1;
      if(keys.current.a||keys.current.ArrowLeft)dx-=1;
      if(keys.current.d||keys.current.ArrowRight)dx+=1;
      if(dx||dy){
        const len=Math.hypot(dx,dy)||1;
        const nx=pos.x+(dx/len)*SPEED;
        const ny=pos.y+(dy/len)*SPEED;
        setPos({x:nx,y:ny});
        socket.emit("move",{x:nx,y:ny});
      }
      requestAnimationFrame(loop);
    };

    window.addEventListener("keydown",down);
    window.addEventListener("keyup",up);
    loop();

    return()=>{
      window.removeEventListener("keydown",down);
      window.removeEventListener("keyup",up);
    };
  },[pos]);

  if(!username){
    return (
      <div className="screen center-container">
        <div className="welcome-box">
          <h1>Welcome</h1>
          <input className="input" placeholder="Username" value={input}
            onChange={e=>setInput(e.target.value)} />
          {error&&<div className="error">{error}</div>}
          <button className="button" onClick={()=>setUsername(input)}>Start</button>
        </div>
      </div>
    );
  }

  return (
    <div className="screen">
      <div className="grid-bg" />
      {Object.entries(players).map(([id,p])=>(
        <React.Fragment key={id}>
          <div className="player" style={{left:p.x,top:p.y}}>
            <img src={characters[p.character]?.img} width="48" height="48"/>
          </div>
          <div className="username-label" style={{left:p.x+24,top:p.y+54}}>
            {p.username}
          </div>
        </React.Fragment>
      ))}
      <div className="hud">
        <button className="babies-button" onClick={()=>setShowModal(true)}>ðŸ‘¶ Babies</button>
      </div>

      {showModal&&(
        <div className="modal-overlay" onClick={()=>setShowModal(false)}>
          <div className="modal" onClick={e=>e.stopPropagation()}>
            <div className="character-grid">
              {Object.keys(characters).map(k=>(
                <div key={k} className={"character-option "+(character===k?"selected":"")}
                  onClick={()=>{
                    setCharacter(k);
                    socket.emit("updateCharacter",k);
                    setShowModal(false);
                  }}>
                  <img src={characters[k].img} width="80"/>
                  <div>{k}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<MovementHub/>,document.getElementById("root"));
</script>
</body>
</html>
